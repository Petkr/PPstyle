#!/bin/bash

lock()
{
    while :
    do
        if mkdir "$1" 2> /dev/null
        then
            break
        fi
    done
}

unlock()
{
    rmdir "$1"
}

for file in $@
do
    dir=`dirname $file`

    lockdir="$dir/PPstyle.lock"

    lock "$lockdir"
    
    format_linked=false

    if [ ! -e "$dir/.clang-format" ]; then
        ln -s "$(pwd)/PPstyle.format" "$dir/.clang-format"
        format_linked=true
    fi

    clang-format -i "$file"

    if $format_linked
    then
        rm "$dir/.clang-format"
    fi

    unlock "$lockdir"
done
